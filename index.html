<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Puter Ultra Chat â€“ Deluxe</title>

    <!-- Puter SDK -->
    <script src="https://js.puter.com/v2/"></script>

    <!-- Markdown + Code Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>

    <style>
        :root {
            --bg: #050509;
            --bg-panel: #0b0b12;
            --bg-sidebar: #080810;
            --border-subtle: #252538;
            --text: #f5f5ff;
            --text-muted: #9ca3af;
            --accent: #4f46e5;
            --accent-soft: rgba(79, 70, 229, 0.18);
            --bubble-user: linear-gradient(135deg, #4f46e5, #6366f1);
            --bubble-bot: #111827;
            --radius-lg: 14px;
            --radius-md: 10px;
            --shadow-soft: 0 18px 40px rgba(0,0,0,0.45);
        }

        body.light {
            --bg: #f3f4f6;
            --bg-panel: #ffffff;
            --bg-sidebar: #f9fafb;
            --border-subtle: #e5e7eb;
            --text: #111827;
            --text-muted: #6b7280;
            --accent: #2563eb;
            --accent-soft: rgba(37, 99, 235, 0.12);
            --bubble-user: linear-gradient(135deg, #2563eb, #4f46e5);
            --bubble-bot: #f3f4f6;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
            color: var(--text);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden; /* Scroll passiert im Chat, nicht im Body */
        }

        body.mobile #sidebar { display: none; }
        body.mobile #main { width: 100%; }
        body.mobile #menuToggle { display: inline-flex; }

        body.tablet #sidebar { width: 200px; }
        body.desktop #sidebar { width: 260px; }

        /* Sidebar */

        #sidebar {
            background: linear-gradient(180deg, var(--bg-sidebar), #020617);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            box-shadow: 8px 0 20px rgba(0,0,0,0.4);
            z-index: 10;
        }

        #sidebar-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        #sidebar-header h2 {
            margin: 0;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
        }

        #sidebar-header .btn-group {
            display: flex;
            gap: 6px;
        }

        button {
            border-radius: 999px;
            border: 1px solid transparent;
            background: var(--accent-soft);
            color: var(--text);
            font-size: 12px;
            padding: 6px 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s ease-out;
        }

        button:hover {
            background: rgba(79, 70, 229, 0.28);
            transform: translateY(-1px);
        }

        button.secondary {
            background: transparent;
            border-color: var(--border-subtle);
            color: var(--text-muted);
        }

        button.secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(79, 70, 229, 0.16);
        }

        #chatList {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .chat-item {
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 10px;
            font-size: 13px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid transparent;
        }

        .chat-item.active {
            background: var(--accent-soft);
            color: var(--text);
            border-color: var(--accent);
        }

        .chat-item:hover {
            background: rgba(148, 163, 184, 0.12);
        }

        .chat-item .dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: var(--accent);
        }

        #sidebar-footer {
            border-top: 1px solid var(--border-subtle);
            padding: 10px 12px;
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div id="sidebar-header">
        <h2>VerlÃ¤ufe</h2>
        <div class="btn-group">
            <button id="newChatBtn">Neu</button>
            <button id="themeToggle" class="secondary">Light</button>
        </div>
    </div>
    <div id="chatList"></div>
    <div id="sidebar-footer">
        <span id="chatCountLabel">0 Chats</span>
        <button id="clearAllBtn" class="secondary">Alle lÃ¶schen</button>
    </div>
</div>

<div id="main">
    <div id="topbar">
        <div id="topbar-left">
            <button id="menuToggle" class="secondary">â˜°</button>
            <div>
                <h1>Puter Ultra Chat</h1>
                <div class="subtitle">Einfaches Prinzip, Deluxeâ€‘UI</div>
            </div>
        </div>
        <div id="topbar-right">
            <button id="compactToggle" class="secondary">Kompakt</button>
            <button id="clearChatBtn" class="secondary">Verlauf lÃ¶schen</button>
        </div>
    </div>
    <div id="chatContainer">
        <div id="chat"></div>

        <div id="inputArea">
            <div id="inputRow">
                <textarea id="prompt" placeholder="Nachricht eingeben (Enter = senden, Shift+Enter = Zeile)"></textarea>
                <button id="sendBtn">Senden</button>
            </div>

            <div id="inputOptions">
                <span id="modeLabel">Modus: Chat</span>
                <div class="right">
                    <button id="imageModeBtn" class="icon-btn">ðŸ–¼ Bild</button>
                    <button id="micBtn" class="icon-btn">ðŸŽ™ Mic</button>
                    <button id="ttsToggle" class="icon-btn">ðŸ”Š TTS an</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
function detectDevice() {
    const ua = navigator.userAgent.toLowerCase();
    if (/mobile|iphone|android|phone/.test(ua)) return "mobile";
    if (/tablet|ipad/.test(ua)) return "tablet";
    return "desktop";
}
document.body.classList.add(detectDevice());

const chatBox = document.getElementById("chat");
const input = document.getElementById("prompt");
const sendBtn = document.getElementById("sendBtn");
const newChatBtn = document.getElementById("newChatBtn");
const chatList = document.getElementById("chatList");
const imageModeBtn = document.getElementById("imageModeBtn");
const modeLabel = document.getElementById("modeLabel");
const themeToggle = document.getElementById("themeToggle");
const micBtn = document.getElementById("micBtn");
const ttsToggle = document.getElementById("ttsToggle");
const menuToggle = document.getElementById("menuToggle");
const sidebar = document.getElementById("sidebar");
const compactToggle = document.getElementById("compactToggle");
const clearChatBtn = document.getElementById("clearChatBtn");
const clearAllBtn = document.getElementById("clearAllBtn");
const chatCountLabel = document.getElementById("chatCountLabel");

let sessions = JSON.parse(localStorage.getItem("ultraSessions") || "[]");
let currentSessionId = null;
let imageMode = false;
let ttsEnabled = true;

const userAvatar = "https://i.imgur.com/4ZQZ4ZQ.png";
const botAvatar = "https://i.imgur.com/8Km9tLL.png";

if (localStorage.getItem("theme") === "light") {
    document.body.classList.add("light");
    themeToggle.textContent = "Dark";
}

function saveSessions() {
    localStorage.setItem("ultraSessions", JSON.stringify(sessions));
    chatCountLabel.textContent = sessions.length + (sessions.length === 1 ? " Chat" : " Chats");
}

function createSession() {
    const id = Date.now().toString();
    sessions.push({ id, title: "Neuer Chat", messages: [] });
    currentSessionId = id;
    saveSessions();
    renderSessionList();
    renderCurrentSession();
}

function getCurrentSession() {
    return sessions.find(s => s.id === currentSessionId);
}

function renderSessionList() {
    chatList.innerHTML = "";
    sessions.forEach(s => {
        const div = document.createElement("div");
        div.className = "chat-item" + (s.id === currentSessionId ? " active" : "");
        const dot = document.createElement("div");
        dot.className = "dot";
        const label = document.createElement("span");
        label.textContent = s.title;
        div.appendChild(dot);
        div.appendChild(label);
        div.onclick = () => {
            currentSessionId = s.id;
            renderSessionList();
            renderCurrentSession();
            if (document.body.classList.contains("mobile")) sidebar.style.display = "none";
        };
        chatList.appendChild(div);
    });
}

function renderCurrentSession() {
    chatBox.innerHTML = "";
    const session = getCurrentSession();
    if (!session) return;

    session.messages.forEach(m => {
        addMessageToUI(m.text || "", m.sender, m.type === "image", m.meta);
    });

    setTimeout(() => {
        chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: "smooth" });
    }, 20);
}

function addMessageToSession(text, sender, type = "text", meta = null) {
    const session = getCurrentSession();
    if (!session) return;
    session.messages.push({ text, sender, type, meta });
    if (session.title === "Neuer Chat" && sender === "user") {
        const words = text.trim().split(/\s+/).slice(0, 6).join(" ");
        session.title = words + (text.trim().split(/\s+/).length > 6 ? "â€¦" : "");
    }
    saveSessions();
    renderSessionList();
}

/* Neue addMessageToUI mit Code-Erkennung und separater Code-Nachricht */
function addMessageToUI(text, sender, isImage = false, meta = null) {
    const msg = document.createElement("div");
    msg.className = "msg " + sender;

    const avatar = document.createElement("div");
    avatar.className = "avatar";
    avatar.style.backgroundImage = `url(${sender === "user" ? userAvatar : botAvatar})`;

    const bubble = document.createElement("div");
    bubble.className = "bubble";

    if (isImage) {
        bubble.innerHTML = "Bild wird geladen...";
    } else {
        // normalen Text ohne CodeblÃ¶cke rendern
        const cleaned = (text || "").replace(/```[\s\S]*?```/g, "").trim();
        bubble.innerHTML = marked.parse(cleaned || "");
        Prism.highlightAllUnder(bubble);
    }

    msg.appendChild(avatar);
    msg.appendChild(bubble);
    chatBox.appendChild(msg);

    // CodeblÃ¶cke erkennen und als separate, formatierte Nachrichten anhÃ¤ngen
    const codeBlocks = [...(text || "").matchAll(/```([a-zA-Z0-9]*)\n([\s\S]*?)```/g)];

    for (const block of codeBlocks) {
        const lang = block[1] || "plaintext";
        const code = block[2];

        const codeMsg = document.createElement("div");
        codeMsg.className = "msg bot";

        const codeAvatar = document.createElement("div");
        codeAvatar.className = "avatar";
        codeAvatar.style.backgroundImage = `url(${botAvatar})`;

        const codeBubble = document.createElement("div");
        codeBubble.className = "bubble";

        codeBubble.innerHTML = `
            <pre><code class="language-${lang}">${code.replace(/</g, "&lt;")}</code></pre>
        `;

        codeMsg.appendChild(codeAvatar);
        codeMsg.appendChild(codeBubble);
        chatBox.appendChild(codeMsg);

        Prism.highlightAllUnder(codeBubble);

        // Copy-Button fÃ¼r den Codeblock
        const copyBtn = document.createElement("button");
        copyBtn.className = "copy-btn";
        copyBtn.textContent = "ðŸ“‹ Kopieren";
        copyBtn.onclick = () => navigator.clipboard.writeText(code);
        const metaRow = document.createElement("div");
        metaRow.className = "meta-row";
        metaRow.appendChild(copyBtn);
        codeBubble.appendChild(metaRow);
    }

    // Meta-Infos (Token + Copy) fÃ¼r normale Bot-Nachricht
    if (sender === "bot") {
        const metaRow = document.createElement("div");
        metaRow.className = "meta-row";

        const tokenCount = Math.ceil((text || "").length / 4);
        const tokenSpan = document.createElement("span");
        tokenSpan.textContent = "~" + tokenCount + " Tokens";
        metaRow.appendChild(tokenSpan);

        const copyBtn = document.createElement("button");
        copyBtn.className = "copy-btn";
        copyBtn.textContent = "ðŸ“‹ Kopieren";
        copyBtn.onclick = () => navigator.clipboard.writeText(text || "");
        metaRow.appendChild(copyBtn);

        bubble.appendChild(metaRow);
    }

    setTimeout(() => {
        chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: "smooth" });
    }, 10);

    return bubble;
}

async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;
    input.value = "";

    addMessageToSession(text, "user");
    addMessageToUI(text, "user");

    const thinkingBubble = addMessageToUI("Denke nachâ€¦", "bot");

    try {
        if (imageMode) {
            const imgElem = await puter.ai.txt2img(text, { model: "gpt-image-1" });

            thinkingBubble.innerHTML = "";
            imgElem.style.maxWidth = "320px";
            imgElem.style.borderRadius = "10px";
            thinkingBubble.appendChild(imgElem);

            addMessageToSession(imgElem.src, "bot", "image");
            return;
        }

        const response = await puter.ai.chat(text);
        const finalText = (response ?? "").toString();

        // Pseudo-Streaming: Text wird "getippt" angezeigt
        let i = 0;
        const interval = setInterval(() => {
            const partial = finalText.slice(0, i);
            thinkingBubble.innerHTML = marked.parse(partial);
            Prism.highlightAllUnder(thinkingBubble);
            i++;
            if (i > finalText.length) {
                clearInterval(interval);

                // Meta (Token + Copy) wird unten ergÃ¤nzt
                const tokenCount = Math.ceil(finalText.length / 4);
                const metaRow = document.createElement("div");
                metaRow.className = "meta-row";

                const tokenSpan = document.createElement("span");
                tokenSpan.textContent = "~" + tokenCount + " Tokens";
                metaRow.appendChild(tokenSpan);

                const copyBtn = document.createElement("button");
                copyBtn.className = "copy-btn";
                copyBtn.textContent = "ðŸ“‹ Kopieren";
                copyBtn.onclick = () => navigator.clipboard.writeText(finalText);
                metaRow.appendChild(copyBtn);

                thinkingBubble.appendChild(metaRow);

                // Falls CodeblÃ¶cke vorhanden sind, werden sie zusÃ¤tzlich als separate Nachrichten angehÃ¤ngt
                const codeBlocks = [...finalText.matchAll(/```([a-zA-Z0-9]*)\n([\s\S]*?)```/g)];
                for (const block of codeBlocks) {
                    const lang = block[1] || "plaintext";
                    const code = block[2];

                    const codeMsg = document.createElement("div");
                    codeMsg.className = "msg bot";

                    const codeAvatar = document.createElement("div");
                    codeAvatar.className = "avatar";
                    codeAvatar.style.backgroundImage = `url(${botAvatar})`;

                    const codeBubble = document.createElement("div");
                    codeBubble.className = "bubble";

                    codeBubble.innerHTML = `
                        <pre><code class="language-${lang}">${code.replace(/</g, "&lt;")}</code></pre>
                    `;

                    codeMsg.appendChild(codeAvatar);
                    codeMsg.appendChild(codeBubble);
                    chatBox.appendChild(codeMsg);

                    Prism.highlightAllUnder(codeBubble);

                    const copyBtn2 = document.createElement("button");
                    copyBtn2.className = "copy-btn";
                    copyBtn2.textContent = "ðŸ“‹ Kopieren";
                    copyBtn2.onclick = () => navigator.clipboard.writeText(code);
                    const metaRow2 = document.createElement("div");
                    metaRow2.className = "meta-row";
                    metaRow2.appendChild(copyBtn2);
                    codeBubble.appendChild(metaRow2);
                }
            }
        }, 8);

        addMessageToSession(finalText, "bot");

        if (ttsEnabled && finalText) {
            const utter = new SpeechSynthesisUtterance(finalText);
            utter.lang = "de-DE";
            speechSynthesis.speak(utter);
        }

    } catch (err) {
        thinkingBubble.innerHTML = "Fehler: " + err;
        console.error(err);
    }
}

sendBtn.onclick = sendMessage;
input.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

newChatBtn.onclick = createSession;

imageModeBtn.onclick = () => {
    imageMode = !imageMode;
    imageModeBtn.textContent = imageMode ? "ðŸ–¼ Bild an" : "ðŸ–¼ Bild";
    modeLabel.textContent = "Modus: " + (imageMode ? "Bild" : "Chat");
};

ttsToggle.onclick = () => {
    ttsEnabled = !ttsEnabled;
    ttsToggle.textContent = ttsEnabled ? "ðŸ”Š TTS an" : "ðŸ”‡ TTS aus";
};

themeToggle.onclick = () => {
    document.body.classList.toggle("light");
    const isLight = document.body.classList.contains("light");
    themeToggle.textContent = isLight ? "Dark" : "Light";
    localStorage.setItem("theme", isLight ? "light" : "dark");
};

micBtn.onclick = () => {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return alert("Spracherkennung nicht unterstÃ¼tzt.");
    const rec = new SR();
    rec.lang = "de-DE";
    rec.start();
    micBtn.textContent = "ðŸŽ™â€¦";
    rec.onresult = e => {
        input.value = (input.value ? input.value + " " : "") + e.results[0][0].transcript;
        micBtn.textContent = "ðŸŽ™ Mic";
    };
    rec.onerror = () => micBtn.textContent = "ðŸŽ™ Mic";
    rec.onend = () => micBtn.textContent = "ðŸŽ™ Mic";
};

compactToggle.onclick = () => {
    document.body.classList.toggle("compact");
};

clearChatBtn.onclick = () => {
    const session = getCurrentSession();
    if (!session) return;
    if (!confirm("Diesen Verlauf wirklich lÃ¶schen?")) return;
    session.messages = [];
    saveSessions();
    renderCurrentSession();
};

clearAllBtn.onclick = () => {
    if (!confirm("Alle VerlÃ¤ufe wirklich lÃ¶schen?")) return;
    sessions = [];
    currentSessionId = null;
    saveSessions();
    renderSessionList();
    chatBox.innerHTML = "";
    createSession();
};

menuToggle.onclick = () => {
    const style = getComputedStyle(sidebar);
    sidebar.style.display = style.display === "none" ? "flex" : "none";
};

if (sessions.length === 0) {
    createSession();
} else {
    currentSessionId = sessions[0].id;
    saveSessions();
    renderSessionList();
    renderCurrentSession();
}
</script>
</body>
</html>
